# Документация по использованию Makefile для Blue-Green деплоя

Данный Makefile предоставляет набор команд для упрощения процессов сборки, тестирования, публикации и деплоя сервисов с использованием стратегии **Blue-Green деплоя** в Kubernetes.

## Основные переменные

- **DOCKER_REGISTRY**: Docker Registry для публикации образов (по умолчанию `constmalytin`).
- **SERVICES**: Список сервисов для обработки (`api-gateway`, `auth-service`).
- **K8S_NAMESPACE**: Пространство имен Kubernetes (по умолчанию `go-messenger`).
- **VERSION**: Версия приложений (по умолчанию короткий хеш коммита Git).
- **DEPLOYMENT_VERSION**: Версия деплоя (`blue` или `green`).

## Общие команды

### Сборка и тестирование

- **Сборка всех сервисов:**
  ```bash
  make build
  ```
- **Сборка отдельного сервиса:**
  ```bash
  make build-service SERVICE=<имя_сервиса>
  ```
  Пример:
  ```bash
  make build-service SERVICE=auth-service
  ```
- **Тестирование всех сервисов:**
  ```bash
  make test
  ```
- **Покрытие кода тестами:**
  ```bash
  make coverage
  ```
- **Установка зависимостей:**
  ```bash
  make deps
  ```

### Статический анализ и форматирование

- **Форматирование кода:**
  ```bash
  make fmt
  ```
- **Запуск линтеров:**
  ```bash
  make lint
  ```
- **Статический анализ кода:**
  ```bash
  make vet
  ```
- **Полная проверка кода (форматирование, линтеры, тесты):**
  ```bash
  make check
  ```

### Публикация образов

- **Публикация всех образов:**
  ```bash
  make push
  ```
- **Публикация отдельного сервиса:**
  ```bash
  make push-service SERVICE=<имя_сервиса>
  ```
  Пример:
  ```bash
  make push-service SERVICE=api-gateway
  ```
- **Сборка и публикация всех сервисов:**
  ```bash
  make build-and-push
  ```
- **Сборка и публикация отдельного сервиса:**
  ```bash
  make build-and-push-service SERVICE=<имя_сервиса>
  ```
  Пример:
  ```bash
  make build-and-push-service SERVICE=auth-service
  ```

## Blue-Green деплой

Стратегия **Blue-Green деплоя** позволяет обновлять приложения без простоев, используя два параллельных окружения: "blue" и "green".

### Команды для деплоя

- **Деплой в окружение blue:**
  ```bash
  make deploy-blue
  ```
- **Деплой в окружение green:**
  ```bash
  make deploy-green
  ```

При выполнении этих команд:

- Собираются и публикуются Docker-образы всех сервисов.
- Применяются Kubernetes манифесты для деплоя сервисов в соответствующее окружение.

### Переключение трафика между окружениями

- **Переключение трафика на версию blue:**
  ```bash
  make switch-to-blue
  ```
- **Переключение трафика на версию green:**
  ```bash
  make switch-to-green
  ```

Эти команды обновляют селекторы в сервисах Kubernetes, перенаправляя трафик на поды с меткой `version: blue` или `version: green`.

### Обновление образов в Kubernetes

- **Обновление образов в деплойментах для текущего окружения:**
  ```bash
  make update-images
  ```
- **Перезапуск деплойментов (опционально):**
  ```bash
  make restart-deployments
  ```

### Деплой отдельных сервисов

- **Деплой `auth-service` с учётом версии деплоя:**
  ```bash
  make deploy-auth-service
  ```
- **Деплой `api-gateway` с учётом версии деплоя:**
  ```bash
  make deploy-api-gateway
  ```

Примечание: Перед выполнением этих команд убедитесь, что переменная `DEPLOYMENT_VERSION` установлена в нужное значение (`blue` или `green`).

## Общий деплой и управление ресурсами Kubernetes

- **Деплой общих ресурсов Kubernetes:**
  ```bash
  make deploy
  ```
  
  Эта команда выполняет:

  - Применение манифестов для создания namespace и configmap.
  - Деплой сервисов в окружение `blue`.
  - Применение манифестов для Ingress и registry.
  - Вывод состояния ресурсов.

- **Просмотр состояния ресурсов в Kubernetes:**
  ```bash
  make log
  ```

Команда `log` отображает список подов, сервисов, деплойментов, ingress, configmaps и секретов в пространстве имен `$(K8S_NAMESPACE)`.

## Дополнительные команды и рекомендации

### Полная проверка кода

- **Выполнение форматирования, статического анализа и тестирования:**
  ```bash
  make check
  ```

### Очистка

- **Удаление временных файлов и кэшированных данных:**
  ```bash
  make clean
  ```

## Пошаговая инструкция по Blue-Green деплою

### Шаг 1: Установка версии

Перед началом убедитесь, что переменная `VERSION` установлена и соответствует версии, которую вы собираетесь деплоить.

Установить версию можно через экспорт переменной:

```bash
export VERSION=<ваша_версия>
```

Или передать её при вызове команды:

```bash
make deploy-green VERSION=<ваша_версия>
```

### Шаг 2: Деплой в новое окружение

Для деплоя сервисов в окружение `green` выполните:

```bash
make deploy-green
```

### Шаг 3: Проверка работы сервисов

Просмотрите состояние ресурсов:

```bash
make log
```

Убедитесь, что поды находятся в статусе `Running`, а сервисы направляют трафик корректно.

### Шаг 4: Переключение трафика

Перенаправьте трафик на окружение `green`:

```bash
make switch-to-green
```

### Шаг 5: Мониторинг

Проверьте работу приложений, убедитесь в отсутствии ошибок.

### Шаг 6: Очистка старого окружения (опционально)

После успешного деплоя и тестирования можно удалить старые деплойменты.

## Важные примечания

- **Использование `envsubst`:** В Makefile используется `envsubst` для подстановки переменных в манифесты. Убедитесь, что необходимые переменные окружения установлены.
- **Совместимость версий:** Следите за соответствием версий образов и деплойментов.
- **Мониторинг и логирование:** Настройте системы мониторинга для отслеживания состояния сервисов после деплоя.


Полный цикл релиза для blue версии:
make VERSION=v1.0.0 release-blue

Полный цикл релиза для green версии:
make VERSION=v1.0.1 release-green

Если версия не указана, будет использован текущий хеш коммита:
make release-blue